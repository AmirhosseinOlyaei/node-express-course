name: PR Review Notification

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR Info
        id: pr
        run: |
          WEEK=$(echo "${{ github.head_ref }}" | grep -oE '[0-9]+' | head -1)
          echo "week=${WEEK:-unknown}" >> $GITHUB_OUTPUT
          echo "action=${{ github.event.action }}" >> $GITHUB_OUTPUT

      - name: Post Gemini Review Instructions
        uses: actions/github-script@v7
        with:
          script: |
            const week = '${{ steps.pr.outputs.week }}';
            const action = '${{ steps.pr.outputs.action }}';
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const prFilesUrl = pr.html_url + '/files';

            const rubricUrl =
              `https://github.com/Code-the-Dream-School/node-express-guidebook/blob/main/assignment-rubrics/week-${week}.md`;

            const lessonUrl =
              'https://github.com/Code-the-Dream-School/node-express-course/wiki';

            let body;

            if (action === 'opened') {
              body = [
                '## ðŸ¤– Gemini Code Assist Review Request',
                '',
                '**Context**',
                `- Assignment week: ${week}`,
                `- PR: #${prNumber}`,
                `- Files changed: ${prFilesUrl}`,
                '',
                '**Authoritative References**',
                `- Rubric: ${rubricUrl}`,
                `- Lesson materials: ${lessonUrl}`,
                '',
                '---',
                '',
                '**Gemini Review Instructions**',
                '',
                'Please perform an automated PR review with the following rules:',
                '',
                '1. Review all changed files in this PR.',
                '2. Evaluate the implementation strictly against the provided rubric.',
                '3. Cross reference logic, patterns, and requirements with the lesson materials.',
                '4. Flag rubric violations as **BLOCKING** issues.',
                '5. Provide **NON-BLOCKING** suggestions for code quality, clarity, or best practices.',
                '6. Ignore formatting and lint issues handled by tooling.',
                '7. Call out missing edge cases, error handling, or incorrect assumptions.',
                '8. If requirements are fully met, explicitly state that the submission passes.',
                '',
                '**Output format**',
                '- Summary verdict (Pass or Needs Changes)',
                '- Blocking issues (if any)',
                '- Non-blocking suggestions',
                '- Rubric coverage confirmation',
                '',
                '---',
                '*Automated Gemini review trigger*'
              ].join('\n');
            } else {
              body = [
                '## ðŸ¤– Gemini Code Assist Re-Review Request',
                '',
                '**Update detected**',
                '- New commits pushed to this PR.',
                `- Files changed: ${prFilesUrl}`,
                '',
                '**Gemini Re-Review Instructions**',
                '',
                'Please:',
                '1. Re-review the updated files only.',
                '2. Verify whether previous blocking feedback has been addressed.',
                '3. Confirm rubric compliance after the changes.',
                '4. Note any remaining gaps or regressions.',
                '',
                '**Output format**',
                '- Status after update (Resolved or Still Needs Changes)',
                '- Remaining blocking issues (if any)',
                '- Confirmation of fixes',
                '',
                '---',
                '*Automated Gemini re-review trigger*'
              ].join('\n');
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });
