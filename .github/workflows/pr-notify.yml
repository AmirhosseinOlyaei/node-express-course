name: PR Review Notification

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout course repo
        uses: actions/checkout@v4
        with:
          path: course-repo

      - name: Checkout guidebook repo
        uses: actions/checkout@v4
        with:
          repository: Code-the-Dream-School/node-express-guidebook
          path: guidebook-repo

      - name: Get PR Info
        id: pr
        run: |
          WEEK=$(echo "${{ github.head_ref }}" | grep -oE '[0-9]+' | head -1)
          echo "week=${WEEK:-unknown}" >> $GITHUB_OUTPUT
          echo "action=${{ github.event.action }}" >> $GITHUB_OUTPUT

      - name: Read Rubric Content
        id: rubric
        run: |
          WEEK="${{ steps.pr.outputs.week }}"
          # Map week numbers to assignment names
          case $WEEK in
            8) RUBRIC_FILE="guidebook-repo/assignment-rubrics/08 - JWT Basics.md" ;;
            *) RUBRIC_FILE="guidebook-repo/assignment-rubrics/week-${WEEK}.md" ;;
          esac
          
          if [ -f "$RUBRIC_FILE" ]; then
            RUBRIC_CONTENT=$(cat "$RUBRIC_FILE")
            echo "content<<EOF" >> $GITHUB_OUTPUT
            echo "$RUBRIC_CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            echo "rubric_file=${RUBRIC_FILE##*/}" >> $GITHUB_OUTPUT
          else
            echo "content=Rubric file not found for week ${WEEK}" >> $GITHUB_OUTPUT
            echo "found=false" >> $GITHUB_OUTPUT
            echo "rubric_file=week-${WEEK}.md" >> $GITHUB_OUTPUT
          fi

      - name: Add Review Checklist Comment
        uses: actions/github-script@v7
        env:
          WEEK: ${{ steps.pr.outputs.week }}
          ACTION: ${{ steps.pr.outputs.action }}
          RUBRIC_FOUND: ${{ steps.rubric.outputs.found }}
          RUBRIC_CONTENT: ${{ steps.rubric.outputs.content }}
          RUBRIC_FILE: ${{ steps.rubric.outputs.rubric_file }}
        with:
          script: |
            const week = process.env.WEEK;
            const action = process.env.ACTION;
            const prNumber = context.payload.pull_request.number;
            const prFilesUrl = context.payload.pull_request.html_url + '/files';
            const rubricFound = process.env.RUBRIC_FOUND === 'true';
            const rubricContent = process.env.RUBRIC_CONTENT || '';
            const rubricFileName = process.env.RUBRIC_FILE || '';
            
            // Escape rubric content to prevent syntax issues inside generated prompts
            const escapedRubricContent = rubricContent
              .replace(/\\/g, '\\\\')
              .replace(/`/g, '\\`')
              .replace(/\${/g, '\\${')
              .replace(/\n/g, '\\n')
              .replace(/\r/g, '\\r')
              .replace(/"/g, '\\"')
              .replace(/'/g, "\\'");

            const rubricUrl = `https://github.com/Code-the-Dream-School/node-express-guidebook/blob/main/assignment-rubrics/${rubricFileName}`;
            const lessonUrl = `https://github.com/AmirhosseinOlyaei/node-express-course/blob/main/lessons/ctd-node-assignment-${week}.md`;

            let body;
            let geminiPrompt;

            if (action === 'opened') {
              body = [
                `## üìã Week ${week} Assignment Submitted`,
                '',
                '**Review Resources:**',
                `- [Week ${week} Rubric](${rubricUrl})`,
                `- [Week ${week} Lesson Materials](${lessonUrl})`,
                `- [PR Files Changed](${prFilesUrl})`,
                '',
                '**AI Review:**',
                `Gemini AI will automatically review this PR against the week ${week} rubric`,
                '',
                '---',
                '*Automated review in progress - Gemini AI analyzing submission*'
              ].join('\n');

              if (rubricFound) {
                geminiPrompt = [
                  `/gemini review`,
                  '',
                  `# Week ${week} Assignment Review - PR #${prNumber}`,
                  '',
                  '## Assignment Context',
                  `- **Week:** ${week}`,
                  `- **Lesson Materials:** ${lessonUrl}`,
                  `- **Files Changed:** ${prFilesUrl}`,
                  '',
                  '---',
                  '',
                  '## Rubric Criteria',
                  '',
                  escapedRubricContent,
                  '',
                  '---',
                  '',
                  '## Review Instructions',
                  '',
                  '**Please review this PR by:**',
                  '1. Examining all code changes in the PR files',
                  '2. Evaluating each criterion from the rubric above',
                  '3. Checking if the code follows best practices from the lesson materials',
                  '4. Identifying any bugs, issues, or improvements needed',
                  '',
                  '**Provide feedback that includes:**',
                  '- ‚úÖ What was done well',
                  '- ‚ùå What needs improvement (reference specific rubric criteria)',
                  '- üí° Specific, actionable suggestions for fixes',
                  '- üìö References to lesson materials when relevant',
                  '',
                  '**Format your review clearly with sections for each major rubric criterion.**'
                ].join('\n');
              } else {
                geminiPrompt = [
                  `/gemini review`,
                  '',
                  `# Week ${week} Assignment Review - PR #${prNumber}`,
                  '',
                  '‚ö†Ô∏è **Note:** Rubric file not found. Performing general code review.',
                  '',
                  `- **Lesson Materials:** ${lessonUrl}`,
                  `- **Rubric (manual check):** ${rubricUrl}`,
                  `- **Files Changed:** ${prFilesUrl}`,
                  '',
                  '**Please review this PR for:**',
                  '1. Code quality and best practices',
                  '2. Proper implementation of Node.js/Express concepts',
                  '3. Error handling and edge cases',
                  '4. Code organization and readability',
                  '5. Any bugs or issues',
                  '',
                  'Provide specific, actionable feedback.'
                ].join('\n');
              }
            } else {
              const commitCount = context.payload.pull_request.commits;
              body = [
                '## üîÑ New commits pushed',
                '',
                'Student has pushed updates to this PR. **Re-review may be needed.**',
                '',
                `- **Total commits:** ${commitCount}`,
                `- [View latest changes](${prFilesUrl})`,
                '',
                '**AI Re-review:**',
                'Gemini AI will automatically re-review this PR to check if previous feedback was addressed'
              ].join('\n');

              if (rubricFound) {
                geminiPrompt = [
                  `/gemini review`,
                  '',
                  `# Week ${week} Re-review - PR #${prNumber}`,
                  '',
                  'üîÑ **New commits detected** - Re-reviewing submission',
                  '',
                  `- **Files Changed:** ${prFilesUrl}`,
                  `- **Lesson Materials:** ${lessonUrl}`,
                  '',
                  '---',
                  '',
                  '## Rubric Criteria',
                  '',
                  escapedRubricContent,
                  '',
                  '---',
                  '',
                  '## Re-review Instructions',
                  '',
                  '**Please:**',
                  '1. Check if previous feedback was addressed',
                  '2. Review new changes against the rubric criteria above',
                  '3. Identify any remaining or new issues',
                  '4. Acknowledge improvements made',
                  '',
                  'Focus on what changed and whether it meets the rubric requirements.'
                ].join('\n');
              } else {
                geminiPrompt = [
                  `/gemini review`,
                  '',
                  `# Week ${week} Re-review - PR #${prNumber}`,
                  '',
                  'üîÑ **New commits detected**`,
                  '',
                  `- **Files Changed:** ${prFilesUrl}`,
                  `- **Rubric:** ${rubricUrl}`,
                  '',
                  '**Please re-review:**',
                  '1. Check if previous feedback was addressed',
                  '2. Review new changes for quality and correctness',
                  '3. Identify any remaining issues'
                ].join('\n');
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: geminiPrompt
            });