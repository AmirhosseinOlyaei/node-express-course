name: PR Review Notification

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR Info
        id: pr
        run: |
          WEEK=$(echo "${{ github.head_ref }}" | grep -oE '[0-9]+' | head -1)
          echo "week=${WEEK:-unknown}" >> $GITHUB_OUTPUT
          echo "action=${{ github.event.action }}" >> $GITHUB_OUTPUT

      - name: Add Review Checklist Comment
        uses: actions/github-script@v7
        with:
          script: |
            const week = '${{ steps.pr.outputs.week }}';
            const action = '${{ steps.pr.outputs.action }}';
            const prNumber = context.payload.pull_request.number;
            const prFilesUrl = context.payload.pull_request.html_url + '/files';
            
            const rubricUrl = `https://github.com/Code-the-Dream-School/node-express-guidebook/blob/main/assignment-rubrics/week-${week}.md`;
            const lessonUrl = `https://github.com/Code-the-Dream-School/node-express-course/wiki/Week-${week}`;

            let body;
            let geminiPrompt;

            if (action === 'opened') {
              body = [
                `## ðŸ“‹ Week ${week} Assignment Submitted`,
                '',
                '**Review Resources:**',
                `- [Week ${week} Rubric](${rubricUrl})`,
                `- [Week ${week} Lesson Materials](${lessonUrl})`,
                `- [PR Files Changed](${prFilesUrl})`,
                '',
                '**AI Review:**',
                `Gemini AI will automatically review this PR against the week ${week} rubric`,
                '',
                '---',
                '*Automated review in progress - Gemini AI analyzing submission*'
              ].join('\n');

              geminiPrompt = [
                `/gemini review`,
                '',
                `**Assignment:** Week ${week}`,
                `**PR Number:** #${prNumber}`,
                '',
                '**Instructions:**',
                `1. Review the code changes in this PR: ${prFilesUrl}`,
                `2. Read the week ${week} rubric: ${rubricUrl}`,
                `3. Read the week ${week} lesson materials: ${lessonUrl}`,
                `4. Evaluate the submission against ALL rubric criteria`,
                `5. Check if the code follows the lesson requirements`,
                `6. Provide specific, actionable feedback`,
                '',
                '**Focus areas:**',
                '- Code quality and best practices',
                '- Completion of all required features',
                '- Proper implementation of concepts from lesson materials',
                '- Any bugs or issues that need fixing'
              ].join('\n');
            } else {
              const commitCount = context.payload.pull_request.commits;
              body = [
                '## ðŸ”„ New commits pushed',
                '',
                'Student has pushed updates to this PR. **Re-review may be needed.**',
                '',
                `- **Total commits:** ${commitCount}`,
                `- [View latest changes](${prFilesUrl})`,
                '',
                '**AI Re-review:**',
                'Gemini AI will automatically re-review this PR to check if previous feedback was addressed'
              ].join('\n');

              geminiPrompt = [
                `/gemini review`,
                '',
                `**Re-review Request:** Week ${week} - PR #${prNumber}`,
                '',
                '**Instructions:**',
                `1. Review the latest changes: ${prFilesUrl}`,
                `2. Check against week ${week} rubric: ${rubricUrl}`,
                `3. Verify if previous feedback was addressed`,
                `4. Identify any remaining issues`,
                '',
                '**Note:** This is a re-review after new commits were pushed.'
              ].join('\n');
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: geminiPrompt
            });